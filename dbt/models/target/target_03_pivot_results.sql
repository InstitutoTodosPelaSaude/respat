{{ config(materialized='table') }}

WITH source_data AS (
    SELECT 
        *
    FROM
    {{ ref("target_02_fix_values") }}
)
SELECT
    *,
    {{ 
        pivot_pathogen_results(
            [
                'CVNCOV',
                'RCOVID'
            ], 
            'detalhe_exame', 
            'result', 
            'SC2_test_result'
        )
    }},
    {{ 
        pivot_pathogen_results(
            [
                'H1N1',
                'FLUAH3',
                'FLUA'
            ], 
            'detalhe_exame', 
            'result', 
            'FLUA_test_result'
        )
    }},
    {{ 
        pivot_pathogen_results(
            [
                'FLUB',
            ], 
            'detalhe_exame', 
            'result', 
            'FLUB_test_result'
        )
    }},
     {{ 
        pivot_pathogen_results(
            [
                'RSVB',
                'RSVAB'
            ], 
            'detalhe_exame', 
            'result', 
            'VSR_test_result'
        )
    }},
    {{ 
        pivot_pathogen_results(
            [
                'METAV'
            ], 
            'detalhe_exame', 
            'result', 
            'META_test_result'
        )
    }},
    {{
        pivot_pathogen_results(
            [
                'HRV'
            ], 
            'detalhe_exame', 
            'result', 
            'RINO_test_result'
        )
    }},
    {{
        pivot_pathogen_results(
            [
                'VPI3',
                'VPI2',
                'VPI1',
                'VPI4'
            ], 
            'detalhe_exame', 
            'result', 
            'PARA_test_result'
        )
    }},
    {{
        pivot_pathogen_results(
            [
                'HADV'
            ], 
            'detalhe_exame', 
            'result', 
            'ADENO_test_result'
        )
    }},
    {{
        pivot_pathogen_results(
            [
                'HBOV'
            ], 
            'detalhe_exame', 
            'result', 
            'BOCA_test_result'
        )
    }},
    {{ 
        pivot_pathogen_results(
            [
                'CVNL63',
                'COR229',
                'CVOC43',
                'HEV',
                'CVHKU1',
                'SARS'
            ], 
            'detalhe_exame', 
            'result', 
            'COVS_test_result'
        )
    }},
    {{
        pivot_pathogen_results(
            [
                ''
            ], 
            'detalhe_exame', 
            'result', 
            'ENTERO_test_result'
        )
    }},
    {{
        pivot_pathogen_results(
            [
                'BPPERT',
                'BPERT',
                'MYCOPN'
            ], 
            'detalhe_exame', 
            'result', 
            'BAC_test_result'
        )
    }}
FROM source_data