{{ config(materialized='table') }}

WITH source_data AS (
    SELECT 
        *
    FROM
    {{ ref("dbmol_02_fix_values") }}
)
SELECT
    *,
    {{ 
        pivot_pathogen_results(
            [
                "SARSC",
                'COVI19Q',
                'COV19Q',
                'NEUCOV', 
                'COV19A', 
                'SARS'
            ], 
            'detalhe_exame', 
            'result', 
            'SC2_test_result'
        )
    }},
    {{ 
        pivot_pathogen_results(
            [
                "INFLUA",
                'INFLH3',
                'INFLU1',
                'INFAG',
                'INFAM'
            ], 
            'detalhe_exame', 
            'result', 
            'FLUA_test_result'
        )
    }},
    {{ 
        pivot_pathogen_results(
            [
                "INFLUB",
                "INFBM",
                "INFBG"
            ], 
            'detalhe_exame', 
            'result', 
            'FLUB_test_result'
        )
    }},
    {{ 
        pivot_pathogen_results(
            [
                'SINCIA',
                'SINCIB',
                'SINRE',
                'HRSVAB'
            ], 
            'detalhe_exame', 
            'result', 
            'VSR_test_result'
        )
    }},
    {{ 
        pivot_pathogen_results(
            [
                'METAP'
            ], 
            'detalhe_exame', 
            'result', 
            'META_test_result'
        )
    }},
    {{
        pivot_pathogen_results(
            [
                'RINOV'
            ], 
            'detalhe_exame', 
            'result', 
            'RINO_test_result'
        )
    }},
    {{
        pivot_pathogen_results(
            [
                'PARA1',
                'PARA2',
                'PARA3',
                'PARA4',
            ], 
            'detalhe_exame', 
            'result', 
            'PARA_test_result'
        )
    }},
    {{
        pivot_pathogen_results(
            [
                'ADENO',
                'ADENA',
                'ADENM',
                'DNADE',
                'ADENF'
            ], 
            'detalhe_exame', 
            'result', 
            'ADENO_test_result'
        )
    }},
    {{
        pivot_pathogen_results(
            [
                'BOCAV'
            ], 
            'detalhe_exame', 
            'result', 
            'BOCA_test_result'
        )
    }},
    {{
        pivot_pathogen_results(
            [
                'COR0C4',
                'COR229',
                'CORHK',
                'CORNL',
            ], 
            'detalhe_exame', 
            'result', 
            'COVS_test_result'
        )
    }},
    {{
        pivot_pathogen_results(
            [
                'ENTERO'
            ], 
            'detalhe_exame', 
            'result', 
            'ENTERO_test_result'
        )
    }},
    {{
        pivot_pathogen_results(
            [
                'ANSP',
                'BPARAP',
                'BPERTU',
                'MYCOP',    
                'MYPNG', 
                'MYPNM', 
                'PARAPE',
                'PERTU',
                'LEGIO',
                'LEGPG','INTERP',
                'LEGPN', 
            ], 
            'detalhe_exame', 
            'result', 
            'BAC_test_result'
        )
    }}
FROM source_data
